#!/bin/sh
# Connect to a database from a file with connection strings, using
# either pgcli or mycli.
# Each line should consist of a connection alias and a corresponding
# connection string, separated with a single space.
#
# Dependencies:
# - fzf
# - mycli
# - pgcli
#
# Usage example:
# fzf_dbs ~/.config/db_connections

conn_file="$1"
[ -z "$conn_file" ] && echo "Connections file wasn't specified." && exit 1
[ ! -f "$conn_file" ] && echo "Connections file doesn't exist." && exit 1

fzf_opts="--reverse --height 40% $FZF_DEFAULT_OPTS"

choice="$(FZF_DEFAULT_OPTS="$fzf_opts" fzf < "$conn_file" |
            awk '{$1=""; print substr($0, 2)}')" # Remove the first column.
[ -z "$choice" ] && exit 1

if echo "$choice" | grep '^postgresql' > /dev/null; then
    ! [ -x "$(command -v pgcli)" ] && echo 'Could not find pgcli.' && exit 1
    pgcli "$choice"
elif echo "$choice" | grep '^mysql' > /dev/null; then
    ! [ -x "$(command -v mycli)" ] && echo 'Could not find mycli.' && exit 1
    mycli "$choice"
else
    echo 'Wrong connection string format.' && exit 1
fi
