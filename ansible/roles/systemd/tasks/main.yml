---
- name: gather facts
  setup:
    filter: ansible_interfaces

- name: check if running in docker
  set_fact:
    in_docker: '{{ "docker0" not in ansible_facts.interfaces }}'

- name: install unit files
  copy:
    src: '{{ item.unit_name }}'
    dest: '/etc/systemd/system/{{ item.unit_name }}'
  loop:
    - { unit_name: lock@.service }
    - { unit_name: newsboat-reload.service }
    - { unit_name: newsboat-reload.timer }
    - { unit_name: pacman-update-files-database.service }
    - { unit_name: pacman-update-files-database.timer }
    - { unit_name: docker-system-prune.service }
    - { unit_name: docker-system-prune.timer }
    - { unit_name: fetch-dotfiles.service }
    - { unit_name: fetch-dotfiles.timer }
    - { unit_name: docker-limit.slice }

- name: reload units
  systemd:
    daemon_reload: yes
  when: not in_docker

- name: enable and start services
  systemd:
    name: '{{ item.unit_name }}'
    enabled: yes
    state: started
  loop:
    - { unit_name: docker.service }
    - { unit_name: newsboat-reload.timer }
    - { unit_name: pacman-update-files-database.timer }
    - { unit_name: paccache.timer } # Discard unused packages weekly.
    - { unit_name: systemd-timesyncd.service } # Sync time.
    - { unit_name: fetch-dotfiles.timer }
    - { unit_name: docker-system-prune.timer }
  when: not in_docker

- name: start docker resource limit slice
  systemd:
    name: docker-limit.slice
    state: started
  when: not in_docker

- name: enable screen lock service
  systemd:
    name: 'lock@{{ user_name }}'
    enabled: yes
  when: not in_docker

- name: copy udev rules
  copy:
    src: udev/50-monitor-hotplug.rules
    dest: /etc/udev/rules.d/

- name: restart systemd-udevd
  systemd:
    name: systemd-udevd
    state: restarted
  when: not in_docker

- name: install user unit files
  become: yes
  become_user: '{{ user_name }}'
  copy:
    src: '{{ item.unit_name }}'
    dest: '{{ user_home }}/.config/systemd/user/{{ item.unit_name }}'
  loop:
    - { unit_name: monitor-hotplug@.service }
    - { unit_name: battery-notification.service }

- name: reload user units
  become: yes
  become_user: '{{ user_name }}'
  systemd:
    daemon_reload: yes
    scope: user
  when: not in_docker

- name: enable and start user services
  become: yes
  become_user: '{{ user_name }}'
  systemd:
    name: '{{ item.unit_name }}'
    enabled: yes
    state: started
    scope: user
  loop:
    - { unit_name: mpd.service }
    - { unit_name: syncthing.service }
    - { unit_name: battery-notification.service }
  when: not in_docker
