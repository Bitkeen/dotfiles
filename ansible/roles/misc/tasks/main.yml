---
- name: create directories in user_home
  file:
    path: "{{ user_home }}/{{ item.value }}"
    state: directory
    owner: "{{ user_name }}"
    group: "{{ user_group }}"
  loop: "{{ dirs | dict2items }}"

- name: create .dotfiles.local symlink
  file:
    src: '{{ dirs.dotfiles_local }}'
    dest: '{{ dotfiles_home }}/.dotfiles.local'
    state: link

# https://wiki.archlinux.org/index.php/GNOME/Keyring#PAM_method
- name: configure PAM for GNOME Keyring
  lineinfile:
    path: /etc/pam.d/login
    line: '{{ item.line }}'
    regexp: '{{ item.line }}'
    insertafter: '{{ item.pattern }}'
  loop:
    - {
      line: 'auth       optional     pam_gnome_keyring.so',
      pattern: '^auth'
    }
    - {
      line: 'session    optional     pam_gnome_keyring.so auto_start',
      pattern: '^session'
    }

- name: configure default directory for Syncthing
  lineinfile:
    path: '{{ user_home }}/.config/syncthing/config.xml'
    # Keep the indentation level.
    line: '        <defaultFolderPath>~/sync</defaultFolderPath>'
    regexp: '<defaultFolderPath>.*</defaultFolderPath>'

- name: configure pacman
  lineinfile:
    path: '/etc/pacman.conf'
    line: '{{ item.line }}'
    regexp: '{{ item.regexp }}'
  loop:
    - {
      line: 'VerbosePkgLists',
      regexp: '^#[ ]?VerbosePkgLists$'
    }
    - {
      line: 'IgnoreGroup = custom',
      regexp: '^#[ ]?IgnoreGroup ='
    }

- name: get submodules
  become: yes
  become_user: "{{ user_name }}"
  command:
    cmd: git submodule update --init --recursive
    chdir: "{{ dotfiles_home }}"

- name: generate helptags for vim
  become: yes
  become_user: "{{ user_name }}"
  command:
    cmd: vim -c 'helptags ALL' -c 'quit'

- name: add user to docker group
  user:
    name: '{{ user_name }}'
    groups: docker
    append: yes
